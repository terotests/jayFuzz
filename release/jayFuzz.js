'use strict';(function(){var __amdDefs__={};var localFs_prototype=function localFs_prototype(){var _promise_prototype=function _promise_prototype(){(function(_myTrait_){_myTrait_.isArray = function(someVar){return Object.prototype.toString.call(someVar) === '[object Array]';};_myTrait_.isFunction = function(fn){return Object.prototype.toString.call(fn) == '[object Function]';};_myTrait_.isObject = function(obj){return obj === Object(obj);};})(this);var later_prototype=function later_prototype(){(function(_myTrait_){var _initDone;var _callers;var _oneTimers;var _everies;var _framers;_myTrait_.add = function(fn, thisObj, args){if(thisObj || args){var tArgs;if(Object.prototype.toString.call(args) === '[object Array]'){tArgs = args;}else {tArgs = Array.prototype.slice.call(arguments, 2);if(!tArgs)tArgs = [];}_callers.push([thisObj, fn, tArgs]);}else {_callers.push(fn);}};_myTrait_.after = function(seconds, fn, name){if(!name){name = 'time' + new Date().getTime() + Math.random(10000000);}_everies[name] = {step:Math.floor(seconds * 1000), fn:fn, nextTime:0, remove:true};};_myTrait_.asap = function(fn){this.add(fn);};_myTrait_.every = function(seconds, fn, name){if(!name){name = 'time' + new Date().getTime() + Math.random(10000000);}_everies[name] = {step:Math.floor(seconds * 1000), fn:fn, nextTime:0};};if(_myTrait_.__traitInit && !_myTrait_.hasOwnProperty('__traitInit'))_myTrait_.__traitInit = _myTrait_.__traitInit.slice();if(!_myTrait_.__traitInit)_myTrait_.__traitInit = [];_myTrait_.__traitInit.push(function(interval, fn){if(!_initDone){this.polyfill();var frame, cancelFrame;if(typeof window != 'undefined'){var frame=window['requestAnimationFrame'], cancelFrame=window['cancelRequestAnimationFrame'];['', 'ms', 'moz', 'webkit', 'o'].forEach(function(x){if(!frame){frame = window[x + 'RequestAnimationFrame'];cancelFrame = window[x + 'CancelAnimationFrame'] || window[x + 'CancelRequestAnimationFrame'];}});}if(!frame)frame = function(cb){return setTimeout(cb, 16);};if(!cancelFrame)cancelFrame = function(id){clearTimeout(id);};_callers = [];_oneTimers = {};_everies = {};_framers = [];var lastMs=0;var _callQueQue=function _callQueQue(){var ms=new Date().getTime();var fn;while(fn = _callers.shift()) {if(Object.prototype.toString.call(fn) === '[object Array]'){fn[1].apply(fn[0], fn[2]);}else {fn();}}for(var i=0; i < _framers.length; i++) {var fFn=_framers[i];fFn();}for(var n in _oneTimers) {if(_oneTimers.hasOwnProperty(n)){var v=_oneTimers[n];v[0](v[1]);delete _oneTimers[n];}}for(var n in _everies) {if(_everies.hasOwnProperty(n)){var v=_everies[n];if(v.nextTime < ms){if(v.remove){if(v.nextTime > 0){v.fn();delete _everies[n];}else {v.nextTime = ms + v.step;}}else {v.fn();v.nextTime = ms + v.step;}}if(v.until){if(v.until < ms){delete _everies[n];}}}}frame(_callQueQue);lastMs = ms;};_callQueQue();_initDone = true;}});_myTrait_.once = function(key, fn, value){_oneTimers[key] = [fn, value];};_myTrait_.onFrame = function(fn){_framers.push(fn);};_myTrait_.polyfill = function(t){};_myTrait_.removeFrameFn = function(fn){var i=_framers.indexOf(fn);if(i >= 0){if(fn._onRemove){fn._onRemove();}_framers.splice(i, 1);return true;}else {return false;}};})(this);};var later=function later(a, b, c, d, e, f, g, h){var m=this, res;if(m instanceof later){var args=[a, b, c, d, e, f, g, h];if(m.__factoryClass){m.__factoryClass.forEach(function(initF){res = initF.apply(m, args);});if(typeof res == 'function'){if(res._classInfo.name != later._classInfo.name)return new res(a, b, c, d, e, f, g, h);}else {if(res)return res;}}if(m.__traitInit){m.__traitInit.forEach(function(initF){initF.apply(m, args);});}else {if(typeof m.init == 'function')m.init.apply(m, args);}}else return new later(a, b, c, d, e, f, g, h);};later._classInfo = {name:'later'};later.prototype = new later_prototype();(function(_myTrait_){_myTrait_.all = function(firstArg){var args;if(this.isArray(firstArg)){args = firstArg;}else {args = Array.prototype.slice.call(arguments, 0);}var targetLen=args.length, rCnt=0, myPromises=[], myResults=new Array(targetLen);return this.then(function(){var allPromise=_promise();if(args.length == 0){allPromise.resolve([]);}args.forEach(function(b, index){if(b.then){myPromises.push(b);b.then(function(v){myResults[index] = v;rCnt++;if(rCnt == targetLen){allPromise.resolve(myResults);}}, function(v){allPromise.reject(v);});}else {allPromise.reject('Not list of promises');}});return allPromise;});};_myTrait_.collect = function(collectFn, promiseList, results){var args;if(this.isArray(promiseList)){args = promiseList;}else {args = [promiseList];}var targetLen=args.length, isReady=false, noMore=false, rCnt=0, myPromises=[], myResults=results || {};return this.then(function(){var allPromise=_promise();args.forEach(function(b, index){if(b.then){myPromises.push(b);b.then(function(v){rCnt++;isReady = collectFn(v, myResults);if(isReady && !noMore || noMore == false && targetLen == rCnt){allPromise.resolve(myResults);noMore = true;}}, function(v){allPromise.reject(v);});}else {allPromise.reject('Not list of promises');}});return allPromise;});};_myTrait_.fail = function(fn){return this.then(null, fn);};_myTrait_.fulfill = function(withValue){if(this._rejected)return;if(this._fulfilled && withValue != this._stateValue){return;}var me=this;this._fulfilled = true;this._stateValue = withValue;var chCnt=this._childPromises.length;while(chCnt--) {var p=this._childPromises.shift();if(p._onFulfill){try{var x=p._onFulfill(withValue);if(typeof x != 'undefined'){p.resolve(x);}else {p.fulfill(withValue);}}catch(e) {p.reject(e);}}else {p.fulfill(withValue);}};this._state = 1;this.triggerStateChange();};if(_myTrait_.__traitInit && !_myTrait_.hasOwnProperty('__traitInit'))_myTrait_.__traitInit = _myTrait_.__traitInit.slice();if(!_myTrait_.__traitInit)_myTrait_.__traitInit = [];_myTrait_.__traitInit.push(function(onFulfilled, onRejected){this._state = 0;this._stateValue = null;this._isAPromise = true;this._childPromises = [];if(this.isFunction(onFulfilled))this._onFulfill = onFulfilled;if(this.isFunction(onRejected))this._onReject = onRejected;if(!onRejected && this.isFunction(onFulfilled)){var me=this;later().asap(function(){onFulfilled(function(v){me.resolve(v);}, function(v){me.reject(v);});});}});_myTrait_.isFulfilled = function(t){return this._state == 1;};_myTrait_.isPending = function(t){return this._state == 0;};_myTrait_.isRejected = function(v){return this._state == 2;};_myTrait_.onStateChange = function(fn){if(!this._listeners)this._listeners = [];this._listeners.push(fn);};_myTrait_.reject = function(withReason){if(this._fulfilled)return;if(this._rejected && withReason != this._rejectReason)return;this._state = 2;this._rejected = true;this._rejectReason = withReason;var me=this;var chCnt=this._childPromises.length;while(chCnt--) {var p=this._childPromises.shift();if(p._onReject){try{p._onReject(withReason);p.reject(withReason);}catch(e) {p.reject(e);}}else {p.reject(withReason);}};this.triggerStateChange();};_myTrait_.rejectReason = function(reason){if(reason){this._rejectReason = reason;return;}return this._rejectReason;};_myTrait_.resolve = function(x){if(this._state > 0)return;if(x == this){this._rejectReason = 'TypeError';this.reject(this._rejectReason);return;}if(this.isObject(x) && x._isAPromise){this._state = x._state;this._stateValue = x._stateValue;this._rejectReason = x._rejectReason;if(this._state === 0){var me=this;x.onStateChange(function(){if(x._state == 1){me.resolve(x.value());}if(x._state == 2){me.reject(x.rejectReason());}});}if(this._state == 1){this.fulfill(this._stateValue);}if(this._state == 2){this.reject(this._rejectReason);}return;}if(this.isObject(x) && x.then && this.isFunction(x.then)){var didCall=false;try{var me=this;x.then.call(x, function(y){if(didCall)return;me.resolve(y);didCall = true;}, function(r){if(didCall)return;me.reject(r);didCall = true;});}catch(e) {if(!didCall)this.reject(e);}return;}this._state = 1;this._stateValue = x;this.fulfill(x);};_myTrait_.state = function(newState){if(typeof newState != 'undefined'){this._state = newState;}return this._state;};_myTrait_.then = function(onFulfilled, onRejected){if(!onRejected)onRejected = function(){};var p=new _promise(onFulfilled, onRejected);var me=this;if(this._state == 1){later().asap(function(){me.fulfill(me.value());});}if(this._state == 2){later().asap(function(){me.reject(me.rejectReason());});}this._childPromises.push(p);return p;};_myTrait_.triggerStateChange = function(t){var me=this;if(!this._listeners)return;this._listeners.forEach(function(fn){fn(me);});this._listeners.length = 0;};_myTrait_.value = function(v){if(typeof v != 'undefined'){this._stateValue = v;return this;}return this._stateValue;};})(this);};var _promise=function _promise(a, b, c, d, e, f, g, h){var m=this, res;if(m instanceof _promise){var args=[a, b, c, d, e, f, g, h];if(m.__factoryClass){m.__factoryClass.forEach(function(initF){res = initF.apply(m, args);});if(typeof res == 'function'){if(res._classInfo.name != _promise._classInfo.name)return new res(a, b, c, d, e, f, g, h);}else {if(res)return res;}}if(m.__traitInit){m.__traitInit.forEach(function(initF){initF.apply(m, args);});}else {if(typeof m.init == 'function')m.init.apply(m, args);}}else return new _promise(a, b, c, d, e, f, g, h);};_promise._classInfo = {name:'_promise'};_promise.prototype = new _promise_prototype();var _localDB_prototype=function _localDB_prototype(){(function(_myTrait_){var _eventOn;var _commands;_myTrait_.guid = function(t){return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);};_myTrait_.isArray = function(t){return Object.prototype.toString.call(t) === '[object Array]';};_myTrait_.isFunction = function(fn){return Object.prototype.toString.call(fn) == '[object Function]';};_myTrait_.isObject = function(t){return t === Object(t);};})(this);var dbTable_prototype=function dbTable_prototype(){(function(_myTrait_){var _eventOn;var _commands;_myTrait_.guid = function(t){return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);};_myTrait_.isArray = function(t){return Object.prototype.toString.call(t) === '[object Array]';};_myTrait_.isFunction = function(fn){return Object.prototype.toString.call(fn) == '[object Function]';};_myTrait_.isObject = function(t){return t === Object(t);};})(this);(function(_myTrait_){_myTrait_._cursorAction = function(mode, usingIndex, actionFn){var prom=_promise();var trans=this._db.transaction(this._table, mode);var store=trans.objectStore(this._table);var cursorRequest;if(usingIndex){var singleKeyRange, indexName;for(var n in usingIndex) {if(usingIndex.hasOwnProperty(n)){indexName = n;singleKeyRange = IDBKeyRange.only(usingIndex[n]);}}if(indexName){var index=store.index(indexName);cursorRequest = index.openCursor(singleKeyRange);}else {prom.reject('invalid index key');return;}}else {cursorRequest = store.openCursor();}trans.oncomplete = function(evt){prom.resolve(true);};cursorRequest.onerror = function(error){console.log(error);};cursorRequest.onsuccess = function(evt){var cursor=evt.target.result;if(cursor){actionFn(cursor);cursor['continue']();}};return prom;};_myTrait_.addRows = function(rows){var prom=_promise();var transaction=this._db.transaction([this._table], 'readwrite');var me=this;transaction.oncomplete = function(event){prom.resolve(true);};transaction.onerror = function(event){prom.reject(event);};var objectStore=transaction.objectStore(this._table);for(var i in rows) {var request=objectStore.add(rows[i]);request.onsuccess = function(event){};}return prom;};_myTrait_.clear = function(t){var prom=_promise();var transaction=this._db.transaction(this._table, 'readwrite');var objectStore=transaction.objectStore(this._table);var request=objectStore.clear();request.onerror = function(event){prom.fail(event.target.errorCode);};request.onsuccess = function(event){prom.resolve(true);};return prom;};_myTrait_.count = function(t){var prom=_promise();var transaction=this._db.transaction([this._table], 'readonly');transaction.objectStore(this._table).count().onsuccess = function(e){prom.resolve(e.target.result);};return prom;};_myTrait_.forEach = function(fn, usingIndex){return this._cursorAction('readonly', usingIndex, function(cursor){fn(cursor.value, cursor);});};_myTrait_.get = function(key){var prom=_promise();var transaction=this._db.transaction(this._table, 'readonly');var objectStore=transaction.objectStore(this._table);var request=objectStore.get(key);request.onerror = function(event){console.log('Could not get ', key);prom.fail(event.target.errorCode);};request.onsuccess = function(event){prom.resolve(request.result);};return prom;};_myTrait_.getAll = function(usingIndex){var items=[], me=this;return _promise(function(result, fail){me._cursorAction('readonly', usingIndex, function(cursor){items.push(cursor.value);}).then(function(){result(items);}).fail(fail);});};if(_myTrait_.__traitInit && !_myTrait_.hasOwnProperty('__traitInit'))_myTrait_.__traitInit = _myTrait_.__traitInit.slice();if(!_myTrait_.__traitInit)_myTrait_.__traitInit = [];_myTrait_.__traitInit.push(function(db, tableName){this._db = db;this._table = tableName;});_myTrait_.readAndDelete = function(usingIndex){var items=[], me=this;return _promise(function(result, fail){me._cursorAction('readwrite', usingIndex, function(cursor){items.push(cursor.value);cursor['delete']();}).then(function(){result(items);}).fail(fail);});};_myTrait_.remove = function(usingIndex){var me=this;return _promise(function(result, fail){me._cursorAction('readwrite', usingIndex, function(cursor){cursor['delete']();}).then(function(){result(true);}).fail(fail);});};_myTrait_.update = function(key, data){var prom=_promise();var me=this;var transaction=this._db.transaction([this._table], 'readwrite');var objectStore=transaction.objectStore(this._table);try{var request=objectStore.get(key);request.onerror = function(event){if(!request.result){me.addRows([data]).then(function(){prom.resolve(data);});return;}prom.fail(event.target.errorCode);};request.onsuccess = function(event){if(!request.result){me.addRows([data]).then(function(){prom.resolve(data);});return;}var requestUpdate=objectStore.put(data);requestUpdate.onerror = function(event){prom.fail('update failed ');};requestUpdate.onsuccess = function(event){prom.resolve(data);};};}catch(e) {return this.addRows([data]);}return prom;};})(this);};var dbTable=function dbTable(a, b, c, d, e, f, g, h){var m=this, res;if(m instanceof dbTable){var args=[a, b, c, d, e, f, g, h];if(m.__factoryClass){m.__factoryClass.forEach(function(initF){res = initF.apply(m, args);});if(typeof res == 'function'){if(res._classInfo.name != dbTable._classInfo.name)return new res(a, b, c, d, e, f, g, h);}else {if(res)return res;}}if(m.__traitInit){m.__traitInit.forEach(function(initF){initF.apply(m, args);});}else {if(typeof m.init == 'function')m.init.apply(m, args);}}else return new dbTable(a, b, c, d, e, f, g, h);};dbTable._classInfo = {name:'dbTable'};dbTable.prototype = new dbTable_prototype();(function(_myTrait_){var _initDone;var _dbList;var _db;_myTrait_._initDB = function(t){if(_db)return;_db = window.indexedDB;_initDone = true;_dbList = _localDB('sys.db', {tables:{databases:{createOptions:{keyPath:'name'}}}});};_myTrait_.clearDatabases = function(fn){_dbList.then(function(){var dbs=_dbList.table('databases');dbs.forEach(function(data, cursor){if(fn(data)){_db.deleteDatabase(data.name);cursor['delete']();}});});};_myTrait_.getDB = function(t){return this._db;};if(_myTrait_.__traitInit && !_myTrait_.hasOwnProperty('__traitInit'))_myTrait_.__traitInit = _myTrait_.__traitInit.slice();if(!_myTrait_.__traitInit)_myTrait_.__traitInit = [];_myTrait_.__traitInit.push(function(dbName, options){if(this._db)return;this._initDB();if(!dbName){return;}var me=this;var request=_db.open(dbName, 4);request.onerror = function(event){console.error(event.target.errorCode);};request.onsuccess = function(event){_dbList.then(function(){var dbs=_dbList.table('databases');dbs.addRows([{name:dbName}]);});me._db = event.target.result;me.resolve(true);};request.onupgradeneeded = function(event){var db=event.target.result;me._db = db;if(options && options.tables){for(var n in options.tables) {if(options.tables.hasOwnProperty(n)){var opts=options.tables[n];var objStore=db.createObjectStore(n, opts.createOptions);if(opts.indexes){for(var iName in opts.indexes) {if(opts.indexes.hasOwnProperty(iName)){var iData=opts.indexes[iName];objStore.createIndex(iName, iName, iData);}}}}}}};});_myTrait_.table = function(name){return dbTable(this._db, name);};})(this);};var _localDB=function _localDB(a, b, c, d, e, f, g, h){var m=this, res;if(m instanceof _localDB){var args=[a, b, c, d, e, f, g, h];if(m.__factoryClass){m.__factoryClass.forEach(function(initF){res = initF.apply(m, args);});if(typeof res == 'function'){if(res._classInfo.name != _localDB._classInfo.name)return new res(a, b, c, d, e, f, g, h);}else {if(res)return res;}}if(m.__traitInit){m.__traitInit.forEach(function(initF){initF.apply(m, args);});}else {if(typeof m.init == 'function')m.init.apply(m, args);}}else return new _localDB(a, b, c, d, e, f, g, h);};_localDB_prototype.prototype = _promise.prototype;_localDB._classInfo = {name:'_localDB'};_localDB.prototype = new _localDB_prototype();var memoryFsFolder_prototype=function memoryFsFolder_prototype(){(function(_myTrait_){_myTrait_.guid = function(t){return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);};_myTrait_.isArray = function(t){return Object.prototype.toString.call(t) === '[object Array]';};_myTrait_.isFunction = function(fn){return Object.prototype.toString.call(fn) == '[object Function]';};_myTrait_.isObject = function(t){return t === Object(t);};})(this);(function(_myTrait_){_myTrait_._isFile = function(fileName){var fold=this._pathObj;if(typeof fold[fileName] != 'undefined' && !this.isObject(fold[fileName]))return true;return false;};_myTrait_._isFolder = function(name){var fold=this._pathObj;if(typeof fold[name] != 'undefined' && this.isObject(fold[name]))return true;return false;};_myTrait_.appendFile = function(fileName, data){var p, me=this;return _promise(function(result, fail){var fold=me._pathObj;if(typeof data != 'string'){fail({result:false, text:'Only string writes are accepted'});return;}if(me._isFile(fileName)){fold[fileName] += data;result({result:true});}else {fold[fileName] = data;result({result:true, text:'Created the file'});}});};_myTrait_.createDir = function(dirName){var p, me=this;return _promise(function(result, fail){var fold=me._pathObj;if(!me._isFile(dirName) && !me._isFolder(dirName)){fold[dirName] = {};}result({result:true});});};_myTrait_.findPath = function(name){if(name.charAt(0) == '/')name = name.substring(0);var parts=name.trim().split('/');var fold=this;return _promise(function(response){if(!parts[0]){response(fold);return;}var sub, rootProm, currFolder;parts.forEach(function(sub){if(!sub || sub.trim().length == 0)return;if(!fold){response(false);return;}if(!rootProm){currFolder = fold;rootProm = fold.isFolder(sub);}else {rootProm = rootProm.then(function(f){currFolder = f;if(f)return f.isFolder(sub);return false;});}rootProm = rootProm.then(function(is_fold){if(is_fold){return currFolder.getFolder(sub);}return false;});});rootProm.then(response);});};_myTrait_.fromData = function(obj){var me=this;return _promise(function(result, fail){if(!me._pathObj){me._pathObj = {};}var all=[];var myProm=_promise();for(var n in obj) {if(me.isObject(obj[n])){if(!me._pathObj[n] || !me._isFolder(n)){me._pathObj[n] = {};}var po=memoryFsFolder(me._server, me._pathObj[n]);all.push(po.fromData(obj[n]));}else {if(obj[n] === true){}else {me._pathObj[n] = obj[n];}}}myProm.all(all).then(function(){result(true);}).fail(fail);myProm.resolve(true);});};_myTrait_.getFolder = function(name){return this.getSubFolderObj(name);};_myTrait_.getSubFolderObj = function(dirName){if(this.isObject(this._pathObj[dirName])){return memoryFsFolder(this._server, this._pathObj[dirName]);}};_myTrait_.getTree = function(t){var treePromise=this.toData({getData:false});return treePromise;};_myTrait_.id = function(t){return this._id;};if(_myTrait_.__traitInit && !_myTrait_.hasOwnProperty('__traitInit'))_myTrait_.__traitInit = _myTrait_.__traitInit.slice();if(!_myTrait_.__traitInit)_myTrait_.__traitInit = [];_myTrait_.__traitInit.push(function(server, pathObj){this._server = server;this._pathObj = pathObj;this._id = this.guid();});_myTrait_.isFile = function(fileName){var p, me=this;return _promise(function(result, fail){result(me._isFile(fileName));});};_myTrait_.isFolder = function(dirName){var p, me=this;return _promise(function(result, fail){result(me._isFolder(dirName));});};_myTrait_.linesToJsonArray = function(str){if(!str || typeof str != 'string')return [];var a=str.split('\n');var res=[];a.forEach(function(line){if(line.trim().length == 0)return;res.push(JSON.parse(line));});return res;};_myTrait_.listFiles = function(filter){var p, me=this;return _promise(function(result, fail){var fold=me._pathObj;var list=[];for(var n in fold) {if(me._isFile(n))list.push(n);}result(list);});};_myTrait_.listFolders = function(filter){var p, me=this;return _promise(function(result, fail){var fold=me._pathObj;var list=[];for(var n in fold) {if(me._isFolder(n))list.push(n);}result(list);});};_myTrait_.readFile = function(fileName, fn){var p, me=this;return _promise(function(result, fail){var fold=me._pathObj;if(me._isFile(fileName)){result(fold[fileName]);return;}fail('File does not exist');});};_myTrait_.removeFile = function(fileName){var p, me=this;return _promise(function(result, fail){var fold=me._pathObj;if(me._isFile(fileName)){delete fold[fileName];}result({result:true, text:'file ' + fileName + ' removed'});});};_myTrait_.toData = function(options, notUsed){var _rootDir=this._rootDir;var me=this;var options=options || {};var fileFilter=options.fileFilter, dirFilter=options.dirFilter;if(typeof options.getData == 'undefined')options.getData = true;return _promise(function(result, fail){var o={};me.listFiles().then(function(list){var cnt=list.length, done=0, waiting=_promise();list.forEach(function(n){if(fileFilter){if(!fileFilter(n)){done++;if(done == cnt)waiting.resolve(true);return;}}if(options.getData){me.readFile(n).then(function(data){o[n] = data;done++;if(done == cnt)waiting.resolve(true);});}else {o[n] = true;done++;if(done == cnt)waiting.resolve(true);}});if(cnt == 0)waiting.resolve(true);return waiting;}).then(function(){return me.listFolders();}).then(function(list){var cnt=list.length, done=0, waiting=_promise();list.forEach(function(dirName){if(dirFilter){if(!dirFilter(dirName)){done++;if(done == cnt)waiting.resolve(true);return;}}var newF=me.getSubFolderObj(dirName);newF.toData(fileFilter, dirFilter).then(function(data){o[dirName] = data;done++;if(done == cnt)waiting.resolve(true);});});if(cnt == 0)waiting.resolve(true);return waiting;}).then(function(){result(o);}).fail(function(){result({});});});};_myTrait_.writeFile = function(fileName, fileData){var p, me=this;return _promise(function(result, fail){var fold=me._pathObj;if(typeof fileData != 'string'){fail({result:false, text:'Only string writes are accepted'});return;}if(!me._isFolder(fileName)){fold[fileName] = fileData;}else {fail({result:false, text:'Modifying the file failed'});return;}result({result:true});});};})(this);};var memoryFsFolder=function memoryFsFolder(a, b, c, d, e, f, g, h){var m=this, res;if(m instanceof memoryFsFolder){var args=[a, b, c, d, e, f, g, h];if(m.__factoryClass){m.__factoryClass.forEach(function(initF){res = initF.apply(m, args);});if(typeof res == 'function'){if(res._classInfo.name != memoryFsFolder._classInfo.name)return new res(a, b, c, d, e, f, g, h);}else {if(res)return res;}}if(m.__traitInit){m.__traitInit.forEach(function(initF){initF.apply(m, args);});}else {if(typeof m.init == 'function')m.init.apply(m, args);}}else return new memoryFsFolder(a, b, c, d, e, f, g, h);};memoryFsFolder._classInfo = {name:'memoryFsFolder'};memoryFsFolder.prototype = new memoryFsFolder_prototype();(function(){if(typeof define !== 'undefined' && define !== null && define.amd != null){__amdDefs__['memoryFsFolder'] = memoryFsFolder;this.memoryFsFolder = memoryFsFolder;}else if(typeof module !== 'undefined' && module !== null && module.exports != null){module.exports['memoryFsFolder'] = memoryFsFolder;}else {this.memoryFsFolder = memoryFsFolder;}}).call(new Function('return this')());var fsServerMemory_prototype=function fsServerMemory_prototype(){(function(_myTrait_){var _servers;_myTrait_._initServers = function(t){if(!_servers){_servers = {};}};_myTrait_.getRootFolder = function(t){var me=this;return memoryFsFolder(me, me._fsData);};if(_myTrait_.__traitInit && !_myTrait_.hasOwnProperty('__traitInit'))_myTrait_.__traitInit = _myTrait_.__traitInit.slice();if(!_myTrait_.__traitInit)_myTrait_.__traitInit = [];_myTrait_.__traitInit.push(function(serverName, createFrom){this._serverName = serverName;this._initServers();this._fsData = createFrom || {};this.resolve(true);});})(this);};var fsServerMemory=function fsServerMemory(a, b, c, d, e, f, g, h){var m=this, res;if(m instanceof fsServerMemory){var args=[a, b, c, d, e, f, g, h];if(m.__factoryClass){m.__factoryClass.forEach(function(initF){res = initF.apply(m, args);});if(typeof res == 'function'){if(res._classInfo.name != fsServerMemory._classInfo.name)return new res(a, b, c, d, e, f, g, h);}else {if(res)return res;}}if(m.__traitInit){m.__traitInit.forEach(function(initF){initF.apply(m, args);});}else {if(typeof m.init == 'function')m.init.apply(m, args);}}else return new fsServerMemory(a, b, c, d, e, f, g, h);};fsServerMemory_prototype.prototype = _promise.prototype;fsServerMemory._classInfo = {name:'fsServerMemory'};fsServerMemory.prototype = new fsServerMemory_prototype();(function(){if(typeof define !== 'undefined' && define !== null && define.amd != null){__amdDefs__['fsServerMemory'] = fsServerMemory;this.fsServerMemory = fsServerMemory;}else if(typeof module !== 'undefined' && module !== null && module.exports != null){module.exports['fsServerMemory'] = fsServerMemory;}else {this.fsServerMemory = fsServerMemory;}}).call(new Function('return this')());var nodeFsFolder_prototype=function nodeFsFolder_prototype(){(function(_myTrait_){_myTrait_.guid = function(t){return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);};_myTrait_.isArray = function(t){return Object.prototype.toString.call(t) === '[object Array]';};_myTrait_.isFunction = function(fn){return Object.prototype.toString.call(fn) == '[object Function]';};_myTrait_.isObject = function(t){return t === Object(t);};})(this);(function(_myTrait_){var fs;var path;_myTrait_._mkDir = function(dirName){if(typeof dirName != 'string'){console.log(JSON.stringiry(dirName));console.log('--- is not object');throw 'WRROR';return;}if(!fs.existsSync(dirName)){fs.mkdirSync(dirName, 502, function(err){});}};_myTrait_.appendFile = function(fileName, data, fn){var _rootDir=this._rootDir;var me=this;return _promise(function(result, fail){if(typeof data != 'string'){fail({result:false, text:'Only string writes are accepted'});return;}fileName = path.basename(fileName);var filePath=_rootDir + '/' + fileName;fs.appendFile(filePath, data, function(err){if(err){fail(err);return;}result({result:true, text:'File written'});});});};_myTrait_.createDir = function(dirName){var _rootDir=this._rootDir;var me=this;return _promise(function(result, fail){var dirN=path.basename(dirName);me._mkDir(_rootDir + '/' + dirN);result({result:true, text:'Directory created'});});};_myTrait_.findPath = function(name){if(name.charAt(0) == '/')name = name.substring(0);var parts=name.trim().split('/');var fold=this;return _promise(function(response){if(!parts[0]){response(fold);return;}var sub, rootProm, currFolder;parts.forEach(function(sub){if(!sub || sub.trim().length == 0)return;if(!fold){response(false);return;}if(!rootProm){currFolder = fold;rootProm = fold.isFolder(sub);}else {rootProm = rootProm.then(function(f){currFolder = f;if(f)return f.isFolder(sub);return false;});}rootProm = rootProm.then(function(is_fold){if(is_fold){return currFolder.getFolder(sub);}return false;});});rootProm.then(response);});};_myTrait_.fromData = function(obj){var me=this;var _rootDir=this._rootDir;return _promise(function(result, fail){var all=[];var myProm=_promise();for(var n in obj) {if(n.indexOf('..') >= 0){fail('.. symbol is not allowed in the file or path names');return;}var name=path.basename(n);if(me.isObject(obj[name])){(function(){var dirDone=_promise();all.push(dirDone);me.createDir(name).then(function(){var newF=me.getSubFolderObj(name);return newF.fromData(obj[name]);}).then(function(){dirDone.resolve();}).fail(function(){dirDone.resolve();});})();}else {if(typeof obj[name] == 'string'){all.push(me.writeFile(name, obj[name]));}}}myProm.all(all).then(function(){result(true);}).fail(fail);myProm.resolve(true);});};_myTrait_.getFolder = function(name){return this.getSubFolderObj(name);};_myTrait_.getSubFolderObj = function(dirName){return nodeFsFolder(this._rootDir + '/' + dirName);};_myTrait_.getTree = function(t){return this.toData({getData:false});};_myTrait_.id = function(t){return this._id;};if(_myTrait_.__traitInit && !_myTrait_.hasOwnProperty('__traitInit'))_myTrait_.__traitInit = _myTrait_.__traitInit.slice();if(!_myTrait_.__traitInit)_myTrait_.__traitInit = [];_myTrait_.__traitInit.push(function(dirName){this._rootDir = dirName;this._id = this.guid();if(!dirName){throw ' The directory must be specified ';return;}if(!(typeof dirName == 'string')){throw ' The directory must be string ';return;}if(dirName.indexOf('..') >= 0 || dirName.indexOf('~') >= 0){throw 'The directory must not contain relative path parts';return;}if(!fs){fs = require('fs');path = require('path');}});_myTrait_.isFile = function(fileName){var _rootDir=this._rootDir;var me=this;return _promise(function(result, fail){fileName = path.basename(fileName);fs.stat(_rootDir + '/' + fileName, function(err, stats){if(err || !stats.isFile()){result(false);return;}result(true);});});};_myTrait_.isFolder = function(fileName){var _rootDir=this._rootDir;var me=this;return _promise(function(result, fail){fileName = path.basename(fileName);fs.stat(_rootDir + '/' + fileName, function(err, stats){if(err || !stats.isDirectory()){result(false);return;}result(true);});});};_myTrait_.linesToJsonArray = function(str){if(!str || typeof str != 'string')return [];var a=str.split('\n');var res=[];a.forEach(function(line){if(line.trim().length == 0)return;res.push(JSON.parse(line));});return res;};_myTrait_.listFiles = function(filter){var _rootDir=this._rootDir;var me=this;return _promise(function(result, fail){fs.readdir(_rootDir, function(err, files){if(err){fail(err);return;}var cnt=files.length, list=[];if(cnt == 0)result(list);files.forEach(function(file){fs.stat(_rootDir + '/' + file, function(err, stats){if(!err && stats.isFile())list.push(file);cnt--;if(cnt == 0)result(list);});});});});};_myTrait_.listFolders = function(filter){var _rootDir=this._rootDir;var me=this;return _promise(function(result, fail){fs.readdir(_rootDir, function(err, files){console.log(files);if(err){fail(err);return;}var cnt=files.length, list=[];if(cnt == 0)result(list);files.forEach(function(file){fs.stat(_rootDir + '/' + file, function(err, stats){if(!err && stats.isDirectory()){console.log('Dir ' + file);list.push(file);}cnt--;if(cnt == 0){console.log('Cnt == 0');result(list);}});});});});};_myTrait_.readFile = function(fileName, fn){var _rootDir=this._rootDir;var me=this;return _promise(function(result, fail){fileName = path.basename(fileName);fs.readFile(_rootDir + '/' + fileName, 'utf8', function(err, data){if(err){fail(err);return;}result(data);});});};_myTrait_.removeFile = function(fileName){var _rootDir=this._rootDir;var me=this;return _promise(function(result, fail){fileName = path.basename(fileName);fs.unlink(_rootDir + '/' + fileName, function(err, data){if(err){fail(err);return;}result({result:true, text:'file ' + fileName + ' removed'});});});};_myTrait_.toData = function(options, notUsed){var _rootDir=this._rootDir;var me=this;var options=options || {};var fileFilter=options.fileFilter, dirFilter=options.dirFilter;if(typeof options.getData == 'undefined')options.getData = true;return _promise(function(result, fail){var o={};me.listFiles().then(function(list){var cnt=list.length, done=0, waiting=_promise();list.forEach(function(n){if(fileFilter){if(!fileFilter(n)){done++;if(done == cnt)waiting.resolve(true);return;}}if(options.getData){me.readFile(n).then(function(data){o[n] = data;done++;if(done == cnt)waiting.resolve(true);});}else {o[n] = true;done++;if(done == cnt)waiting.resolve(true);}});if(cnt == 0)waiting.resolve(true);return waiting;}).then(function(){return me.listFolders();}).then(function(list){var cnt=list.length, done=0, waiting=_promise();list.forEach(function(dirName){if(dirFilter){if(!dirFilter(dirName)){done++;if(done == cnt)waiting.resolve(true);return;}}var newF=me.getSubFolderObj(dirName);newF.toData(fileFilter, dirFilter).then(function(data){o[dirName] = data;done++;if(done == cnt)waiting.resolve(true);});});if(cnt == 0)waiting.resolve(true);return waiting;}).then(function(){result(o);}).fail(function(){result({});});});};_myTrait_.writeFile = function(fileName, fileData, fn){var _rootDir=this._rootDir;var me=this;return _promise(function(result, fail){if(typeof fileData != 'string'){fail({result:false, text:'Only string writes are accepted'});return;}fileName = path.basename(fileName);fs.writeFile(_rootDir + '/' + fileName, fileData, function(err, data){if(err){fail(err);return;}result({result:true, text:'File written'});});});};})(this);};var nodeFsFolder=function nodeFsFolder(a, b, c, d, e, f, g, h){var m=this, res;if(m instanceof nodeFsFolder){var args=[a, b, c, d, e, f, g, h];if(m.__factoryClass){m.__factoryClass.forEach(function(initF){res = initF.apply(m, args);});if(typeof res == 'function'){if(res._classInfo.name != nodeFsFolder._classInfo.name)return new res(a, b, c, d, e, f, g, h);}else {if(res)return res;}}if(m.__traitInit){m.__traitInit.forEach(function(initF){initF.apply(m, args);});}else {if(typeof m.init == 'function')m.init.apply(m, args);}}else return new nodeFsFolder(a, b, c, d, e, f, g, h);};nodeFsFolder._classInfo = {name:'nodeFsFolder'};nodeFsFolder.prototype = new nodeFsFolder_prototype();(function(){if(typeof define !== 'undefined' && define !== null && define.amd != null){__amdDefs__['nodeFsFolder'] = nodeFsFolder;this.nodeFsFolder = nodeFsFolder;}else if(typeof module !== 'undefined' && module !== null && module.exports != null){module.exports['nodeFsFolder'] = nodeFsFolder;}else {this.nodeFsFolder = nodeFsFolder;}}).call(new Function('return this')());var indexedDBFsFolder_prototype=function indexedDBFsFolder_prototype(){(function(_myTrait_){var _eventOn;var _commands;_myTrait_.guid = function(t){return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);};_myTrait_.isArray = function(t){return Object.prototype.toString.call(t) === '[object Array]';};_myTrait_.isFunction = function(fn){return Object.prototype.toString.call(fn) == '[object Function]';};_myTrait_.isObject = function(t){return t === Object(t);};})(this);(function(_myTrait_){var _instances;if(!_myTrait_.hasOwnProperty('__factoryClass'))_myTrait_.__factoryClass = [];_myTrait_.__factoryClass.push(function(server, pathString){var id=server.getID() + pathString;if(!_instances){_instances = {};}if(_instances[id]){return _instances[id];}else {_instances[id] = this;}});_myTrait_._filePath = function(fileName){var str=this._path + '/' + fileName;str = str.replace('//', '/');return str;};_myTrait_._initCreateDir = function(dirName){var p, me=this;var local=this._db, server=this._server;return _promise(function(result, fail){me._isFolder(dirName).then(function(isFolder){if(!isFolder){var row={name:me._normalize(me._path + dirName + '/'), parentFolder:me._path};return local.table('folders').addRows([row]);}else {return 'OK';}}).then(function(){result({result:true, text:'folder ' + dirName + ' created'});}).fail(fail);});};_myTrait_._initFromData = function(obj){var me=this;var local=this._db, server=this._server;return _promise(function(result, fail){var all=[];var myProm=_promise();console.log('__initFromData');console.log(obj);for(var n in obj) {if(n.indexOf('..') >= 0){fail('.. symbol is not allowed in the file or path names');result(false);return;}var name=n;console.log('Creating ', name);if(me.isObject(obj[name])){(function(){var dirDone=_promise();all.push(dirDone);me._initCreateDir(name).then(function(){var newF=me.getSubFolderObj(name);return newF._initFromData(obj[name]);}).then(function(){dirDone.resolve();}).fail(function(){dirDone.resolve();});})();}else {if(typeof obj[name] == 'string'){console.log('should write ' + obj[name]);all.push(me._writeFile(name, obj[name]));}}}myProm.all(all).then(function(){result(true);}).fail(fail);myProm.resolve(true);});};_myTrait_._isFile = function(fileName){var me=this;return _promise(function(result, failure){me._loadFiles().then(function(list){for(var i=0; i < list.length; i++) {if(list[i].name == fileName){result(true);return;}}result(false);}).fail(failure);});};_myTrait_._isFolder = function(name){var me=this;return _promise(function(result, failure){name = me._normalize(me._path + '/' + name + '/');me._loadFolders().then(function(list){for(var i=0; i < list.length; i++) {if(list[i].name == name){result(true);return;}}result(false);}).fail(failure);});};_myTrait_._lastPath = function(str){var parts=str.split('/');var str=parts.pop();while(parts.length > 0) {if(str.length > 0)return str;str = parts.pop();}return str;};_myTrait_._loadFiles = function(t){var local=this._db, me=this;return _promise(function(result){local.table('files').getAll({folderName:me._path}).then(function(res){me._fileCache = res;result(me._fileCache);});});};_myTrait_._loadFolders = function(t){var local=this._db, me=this;return _promise(function(result){local.table('folders').getAll({parentFolder:me._path}).then(function(res){me._folderCache = res;result(me._folderCache);});});};_myTrait_._normalize = function(pathName){var str=pathName.replace('//', '/');return str;};_myTrait_._onlyClearWrites = function(fileName){var p, me=this;var local=this._db, server=this._server;return _promise(function(result, fail){server.then(function(){return me._isFile(fileName);}).then(function(isFile){if(!isFile){return local.table('files').addRows([{name:fileName, folderName:me._path}]);}else {return 'OK';}}).then(function(){return local.table('fileWrites').remove({filePath:me._filePath(fileName)});}).then(function(){result({result:true, text:'writes cleared'});}).fail(fail);});};_myTrait_._removeFileFromCache = function(fileName){if(this._fileCache){for(var i=0; i < this._fileCache.length; i++) {if(this._fileCache[i].name == fileName){this._fileCache.splice(i, 1);return;}}}};_myTrait_._removeFolderFromCache = function(name){if(this._folderCache){for(var i=0; i < this._fileCache.length; i++) {if(this._folderCache[i].name == name){this._folderCache.splice(i, 1);return;}}}};_myTrait_._writeFile = function(fileName, fileData){var p, me=this;var local=this._db, server=this._server;console.log('writeFile ', fileName, fileData);return _promise(function(result, fail){if(typeof fileData != 'string'){fail({result:false, text:'Only string writes are accepted'});return;}me._isFile(fileName).then(function(isFile){if(!isFile){return local.table('files').addRows([{name:fileName, folderName:me._path}]);}else {return 'OK';}}).then(function(){return local.table('fileWrites').remove({filePath:me._filePath(fileName)});}).then(function(){return local.table('fileWrites').addRows([{filePath:me._filePath(fileName), data:fileData}]);}).then(function(){result({result:true, text:'file ' + fileName + ' written'});}).fail(fail);});};_myTrait_.appendFile = function(fileName, data){var p, me=this;var local=this._db, server=this._server;return _promise(function(result, fail){if(typeof data != 'string'){fail({result:false, text:'Only string writes are accepted'});return;}server.then(function(){return me._isFile(fileName);}).then(function(isFile){if(!isFile){return local.table('files').addRows([{name:fileName, folderName:me._path}]);}else {return 'OK';}}).then(function(){return local.table('fileWrites').addRows([{filePath:me._filePath(fileName), data:data}]);}).then(function(){result({result:true, text:'file ' + fileName + ' written'});}).fail(fail);});};_myTrait_.createDir = function(dirName){var p, me=this;var local=this._db, server=this._server;return _promise(function(result, fail){server.then(function(){return me._isFolder(dirName);}).then(function(isFolder){if(!isFolder){var row={name:me._normalize(me._path + dirName + '/'), parentFolder:me._path};return local.table('folders').addRows([row]);}else {return 'OK';}}).then(function(){result({result:true, text:'folder ' + dirName + ' created'});}).fail(fail);});};_myTrait_.findPath = function(name){if(name.charAt(0) == '/')name = name.substring(0);var parts=name.trim().split('/');var fold=this;return _promise(function(response){if(!parts[0]){response(fold);return;}var sub, rootProm, currFolder;parts.forEach(function(sub){if(!sub || sub.trim().length == 0)return;if(!fold){response(false);return;}if(!rootProm){currFolder = fold;rootProm = fold.isFolder(sub);}else {rootProm = rootProm.then(function(f){currFolder = f;if(f)return f.isFolder(sub);return false;});}rootProm = rootProm.then(function(is_fold){if(is_fold){return currFolder.getFolder(sub);}return false;});});rootProm.then(response);});};_myTrait_.fromData = function(obj){var me=this;var local=this._db, server=this._server;return _promise(function(result, fail){var all=[];var myProm=_promise();server.then(function(){for(var n in obj) {if(n.indexOf('..') >= 0){fail('.. symbol is not allowed in the file or path names');return;}var name=n;if(me.isObject(obj[name])){(function(){var dirDone=_promise();all.push(dirDone);me.createDir(name).then(function(){var newF=me.getSubFolderObj(name);return newF.fromData(obj[name]);}).then(function(){dirDone.resolve();}).fail(function(){dirDone.resolve();});})();}else {if(typeof obj[name] == 'string'){all.push(me.writeFile(name, obj[name]));}}}myProm.all(all).then(function(){result(true);}).fail(fail);myProm.resolve(true);});});};_myTrait_.getFolder = function(name){return this.getSubFolderObj(name);};_myTrait_.getSubFolderObj = function(dirName){var subPath=this._normalize(this._path + dirName + '/');return indexedDBFsFolder(this._server, subPath);};_myTrait_.getTree = function(t){var treePromise=this.toData({getData:false});return treePromise;};_myTrait_.id = function(t){return this._id;};if(_myTrait_.__traitInit && !_myTrait_.hasOwnProperty('__traitInit'))_myTrait_.__traitInit = _myTrait_.__traitInit.slice();if(!_myTrait_.__traitInit)_myTrait_.__traitInit = [];_myTrait_.__traitInit.push(function(server, pathString){this._server = server;this._path = pathString;this._id = this.guid();this._db = server.getDb();});_myTrait_.isFile = function(fileName){var p, me=this;return _promise(function(result, fail){result(me._isFile(fileName));});};_myTrait_.isFolder = function(fileName){var p, me=this;return _promise(function(result, fail){result(me._isFolder(fileName));});};_myTrait_.linesToJsonArray = function(str){if(!str || typeof str != 'string')return [];var a=str.split('\n');var res=[];a.forEach(function(line){if(line.trim().length == 0)return;res.push(JSON.parse(line));});return res;};_myTrait_.listFiles = function(filter){var p, me=this;var local=this._db, server=this._server;return _promise(function(result, fail){server.then(function(){me._loadFiles().then(function(list){var res=[];list.forEach(function(data){res.push(data.name);});result(res);});}).fail(fail);});};_myTrait_.listFolders = function(filter){var p, me=this;var local=this._db, server=this._server;return _promise(function(result, fail){server.then(function(){me._loadFolders().then(function(list){var res=[];list.forEach(function(data){res.push(data.name);});result(res);});}).fail(fail);});};_myTrait_.readFile = function(fileName, notUsed){var p, me=this;var local=this._db, server=this._server;return _promise(function(result, fail){server.then(function(){return me._isFile(fileName);}).then(function(isFile){if(!isFile){throw 'The file does not exist';}else {return 'OK';}}).then(function(){return local.table('fileWrites').getAll({filePath:me._filePath(fileName)});}).then(function(list){var str='';list.forEach(function(write){str += write.data;});result(str);}).fail(fail);});};_myTrait_.removeFile = function(fileName){var p, me=this;var local=this._db, server=this._server;return _promise(function(result, fail){var bIsFile=false;server.then(function(){return me._isFile(fileName);}).then(function(isFile){bIsFile = isFile;if(!isFile){return 'OK';}else {return local.table('fileWrites').remove({filePath:me._filePath(fileName)});}}).then(function(){if(bIsFile){return local.table('files')._cursorAction('readwrite', {folderName:me._path}, function(cursor){var data=cursor.value;if(data.name == fileName){cursor['delete']();me._removeFileFromCache(fileName);}});}else {return 'OK';}}).then(function(){result({result:true, text:'file ' + fileName + ' removed'});}).fail(fail);});};_myTrait_.toData = function(options, notUsed){var me=this;var options=options || {};var fileFilter=options.fileFilter, dirFilter=options.dirFilter;if(typeof options.getData == 'undefined')options.getData = true;return _promise(function(result, fail){var o={};me.listFiles().then(function(list){var cnt=list.length, done=0, waiting=_promise();list.forEach(function(n){if(fileFilter){if(!fileFilter(n)){done++;if(done == cnt)waiting.resolve(true);return;}}if(options.getData){me.readFile(n).then(function(data){o[n] = data;done++;if(done == cnt)waiting.resolve(true);});}else {o[n] = true;done++;if(done == cnt)waiting.resolve(true);}});if(cnt == 0)waiting.resolve(true);return waiting;}).then(function(){return me.listFolders();}).then(function(list){var cnt=list.length, done=0, waiting=_promise();list.forEach(function(dirName){if(dirFilter){if(!dirFilter(dirName)){done++;if(done == cnt)waiting.resolve(true);return;}}var subName=me._lastPath(dirName);var newF=me.getSubFolderObj(subName);newF.toData(fileFilter, dirFilter).then(function(data){o[subName] = data;done++;if(done == cnt)waiting.resolve(true);});});if(cnt == 0)waiting.resolve(true);return waiting;}).then(function(){result(o);}).fail(function(){result({});});});};_myTrait_.writeFile = function(fileName, fileData){var p, me=this;var local=this._db, server=this._server;return _promise(function(result, fail){if(typeof fileData != 'string'){fail({result:false, text:'Only string writes are accepted'});return;}server.then(function(){return me._isFile(fileName);}).then(function(isFile){if(!isFile){return local.table('files').addRows([{name:fileName, folderName:me._path}]);}else {return 'OK';}}).then(function(){return local.table('fileWrites').remove({filePath:me._filePath(fileName)});}).then(function(){return local.table('fileWrites').addRows([{filePath:me._filePath(fileName), data:fileData}]);}).then(function(){result({result:true, text:'file ' + fileName + ' written'});}).fail(fail);});};})(this);};var indexedDBFsFolder=function indexedDBFsFolder(a, b, c, d, e, f, g, h){var m=this, res;if(m instanceof indexedDBFsFolder){var args=[a, b, c, d, e, f, g, h];if(m.__factoryClass){m.__factoryClass.forEach(function(initF){res = initF.apply(m, args);});if(typeof res == 'function'){if(res._classInfo.name != indexedDBFsFolder._classInfo.name)return new res(a, b, c, d, e, f, g, h);}else {if(res)return res;}}if(m.__traitInit){m.__traitInit.forEach(function(initF){initF.apply(m, args);});}else {if(typeof m.init == 'function')m.init.apply(m, args);}}else return new indexedDBFsFolder(a, b, c, d, e, f, g, h);};indexedDBFsFolder._classInfo = {name:'indexedDBFsFolder'};indexedDBFsFolder.prototype = new indexedDBFsFolder_prototype();(function(){if(typeof define !== 'undefined' && define !== null && define.amd != null){__amdDefs__['indexedDBFsFolder'] = indexedDBFsFolder;this.indexedDBFsFolder = indexedDBFsFolder;}else if(typeof module !== 'undefined' && module !== null && module.exports != null){module.exports['indexedDBFsFolder'] = indexedDBFsFolder;}else {this.indexedDBFsFolder = indexedDBFsFolder;}}).call(new Function('return this')());var fsServerIndexedDB_prototype=function fsServerIndexedDB_prototype(){(function(_myTrait_){_myTrait_.guid = function(t){return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);};_myTrait_.isArray = function(t){return Object.prototype.toString.call(t) === '[object Array]';};_myTrait_.isFunction = function(fn){return Object.prototype.toString.call(fn) == '[object Function]';};_myTrait_.isObject = function(t){return t === Object(t);};})(this);(function(_myTrait_){var _instances;if(!_myTrait_.hasOwnProperty('__factoryClass'))_myTrait_.__factoryClass = [];_myTrait_.__factoryClass.push(function(id){if(!_instances){_instances = {};}if(_instances[id]){return _instances[id];}else {_instances[id] = this;}});_myTrait_.createFrom = function(t){};_myTrait_.getDb = function(t){return this._db;};_myTrait_.getID = function(t){if(!this._id){this._id = this.guid();}return this._id;};_myTrait_.getRootFolder = function(t){return indexedDBFsFolder(this, '/');};if(_myTrait_.__traitInit && !_myTrait_.hasOwnProperty('__traitInit'))_myTrait_.__traitInit = _myTrait_.__traitInit.slice();if(!_myTrait_.__traitInit)_myTrait_.__traitInit = [];_myTrait_.__traitInit.push(function(serverName, createFrom){var me=this;this._serverName = serverName;this._dbName = 'vserver://' + serverName;this._db = _localDB(this._dbName, {tables:{folders:{createOptions:{keyPath:'name'}, indexes:{parentFolder:{unique:false}}}, files:{createOptions:{autoIncrement:true}, indexes:{folderName:{unique:false}}}, fileWrites:{createOptions:{autoIncrement:true}, indexes:{filePath:{unique:false}}}}});this._db.then(function(){me._db.table('folders').count().then(function(cnt){if(cnt >= 1){if(createFrom){me.getRootFolder()._initFromData(createFrom).then(function(){me.resolve(true);});}else {me.resolve(true);}}else {me._db.table('folders').addRows([{name:'/'}]).then(function(){if(createFrom){me.getRootFolder()._initFromData(createFrom).then(function(){me.resolve(true);});}else {me.resolve(true);}});}});});});})(this);};var fsServerIndexedDB=function fsServerIndexedDB(a, b, c, d, e, f, g, h){var m=this, res;if(m instanceof fsServerIndexedDB){var args=[a, b, c, d, e, f, g, h];if(m.__factoryClass){m.__factoryClass.forEach(function(initF){res = initF.apply(m, args);});if(typeof res == 'function'){if(res._classInfo.name != fsServerIndexedDB._classInfo.name)return new res(a, b, c, d, e, f, g, h);}else {if(res)return res;}}if(m.__traitInit){m.__traitInit.forEach(function(initF){initF.apply(m, args);});}else {if(typeof m.init == 'function')m.init.apply(m, args);}}else return new fsServerIndexedDB(a, b, c, d, e, f, g, h);};fsServerIndexedDB_prototype.prototype = _promise.prototype;fsServerIndexedDB._classInfo = {name:'fsServerIndexedDB'};fsServerIndexedDB.prototype = new fsServerIndexedDB_prototype();(function(){if(typeof define !== 'undefined' && define !== null && define.amd != null){__amdDefs__['fsServerIndexedDB'] = fsServerIndexedDB;this.fsServerIndexedDB = fsServerIndexedDB;}else if(typeof module !== 'undefined' && module !== null && module.exports != null){module.exports['fsServerIndexedDB'] = fsServerIndexedDB;}else {this.fsServerIndexedDB = fsServerIndexedDB;}}).call(new Function('return this')());var fsServerNode_prototype=function fsServerNode_prototype(){(function(_myTrait_){var _servers;_myTrait_._initServers = function(t){if(!_servers){_servers = {};}};_myTrait_.getRootFolder = function(t){var root=this._fsRoot;if(!root || root.length < 15 || root.indexOf('..') >= 0){throw 'Invalid root folder';return false;}var me=this;return nodeFsFolder(me._fsRoot);};if(_myTrait_.__traitInit && !_myTrait_.hasOwnProperty('__traitInit'))_myTrait_.__traitInit = _myTrait_.__traitInit.slice();if(!_myTrait_.__traitInit)_myTrait_.__traitInit = [];_myTrait_.__traitInit.push(function(fsRoot, createFrom){if(!fsRoot || fsRoot.length < 15 || fsRoot.indexOf('..') >= 0){throw 'Invalid root folder';return false;}this._fsRoot = fsRoot;if(createFrom){}else {this.resolve(true);}});})(this);};var fsServerNode=function fsServerNode(a, b, c, d, e, f, g, h){var m=this, res;if(m instanceof fsServerNode){var args=[a, b, c, d, e, f, g, h];if(m.__factoryClass){m.__factoryClass.forEach(function(initF){res = initF.apply(m, args);});if(typeof res == 'function'){if(res._classInfo.name != fsServerNode._classInfo.name)return new res(a, b, c, d, e, f, g, h);}else {if(res)return res;}}if(m.__traitInit){m.__traitInit.forEach(function(initF){initF.apply(m, args);});}else {if(typeof m.init == 'function')m.init.apply(m, args);}}else return new fsServerNode(a, b, c, d, e, f, g, h);};fsServerNode_prototype.prototype = _promise.prototype;fsServerNode._classInfo = {name:'fsServerNode'};fsServerNode.prototype = new fsServerNode_prototype();(function(){if(typeof define !== 'undefined' && define !== null && define.amd != null){__amdDefs__['fsServerNode'] = fsServerNode;this.fsServerNode = fsServerNode;}else if(typeof module !== 'undefined' && module !== null && module.exports != null){module.exports['fsServerNode'] = fsServerNode;}else {this.fsServerNode = fsServerNode;}}).call(new Function('return this')());(function(_myTrait_){if(_myTrait_.__traitInit && !_myTrait_.hasOwnProperty('__traitInit'))_myTrait_.__traitInit = _myTrait_.__traitInit.slice();if(!_myTrait_.__traitInit)_myTrait_.__traitInit = [];_myTrait_.__traitInit.push(function(aclFile){});})(this);};var localFs=function localFs(a, b, c, d, e, f, g, h){var m=this, res;if(m instanceof localFs){var args=[a, b, c, d, e, f, g, h];if(m.__factoryClass){m.__factoryClass.forEach(function(initF){res = initF.apply(m, args);});if(typeof res == 'function'){if(res._classInfo.name != localFs._classInfo.name)return new res(a, b, c, d, e, f, g, h);}else {if(res)return res;}}if(m.__traitInit){m.__traitInit.forEach(function(initF){initF.apply(m, args);});}else {if(typeof m.init == 'function')m.init.apply(m, args);}}else return new localFs(a, b, c, d, e, f, g, h);};localFs._classInfo = {name:'localFs'};localFs.prototype = new localFs_prototype();if(typeof define !== 'undefined' && define !== null && define.amd != null){define(__amdDefs__);}}).call(new Function('return this')());